### nginx 负载均衡算法

`Nginx`提供的负载均衡策略有 2 种：内置策略和扩展策略。

##### 内置策略

​	轮询，加权轮询，`Ip hash`。

##### 扩展策略

`fair` 、`url hash`

###### 1. 轮询/轮询加权（默认）

~~~shell
# weight 为轮询加权
upstream test {
	server 192.168.0.100:8080 weight=1 fail_timeout=20s;
	server 192.168.0.101:8080 weight=2 fail_timeout=20s;
}
~~~

###### 2. ip_hash算法

解释

轮询方式存在一个问题，在负载均衡系统中，假如用户在某台服务器上登录了，那么该用户第二次请求的时候，因为我们是负载均衡系统，每次请求都会重新定位到服务器集群中的某一个，那么**已经登录某一个服务器的用户再重新定位到另一个服务器，其登录信息将会丢失，这样显然是不妥的**。

采用`ip_hash`指令解决这个问题，如果客户已经访问了某个服务器，当用户再次访问时，会将该请求通过**哈希算法，自动定位到该服务器**。

~~~shell
对于访问的ip，他会做一次hash运算，并对当前的负载应用数量做一次取余运算，这种算法能保证同一个ip访问的是同一台应用服务器。
upstream test {
    ip_hash;
    server 127.0.0.1:8081;
    server 127.0.0.1:8082;
}
~~~

###### 3. url_hash算法

~~~shell
对于请求的url进行hash运算，这种算法能保证同一个url访问的是同一台应用服务器。使每个url定向到同一个（对应的）后端服务器，后端服务器为缓存时比较有效。
upstream test {
    hash $request_uri;
    hash_method crc32;
    server 127.0.0.1:8081;
    server 127.0.0.1:8082;
}
~~~

###### 4. fair

按后端服务器的响应时间来分配请求，响应时间短的优先分配。

~~~shell
upstream test {
    fair;
    server 192.168.0.100:8080;
    server 192.168.0.101:8080;
    server 192.168.0.102:8080;
}
~~~

###### 5. least_conn(最少连接)

~~~shell
upstream test {
    least_conn;
    server 192.168.101.60:81;
    server 192.168.101.77:80;
}
~~~



##### 