## 拥塞控制和流量控制

### TCP拥塞控制

~~~
TCP的拥塞机制解决的是网络延时突然增加，触发大量的数据重传，导致网络负担加重问题
~~~

##### 造成拥塞的可能原因

>1. 数据包在半路丢失了
>2. 网络通信处于拥挤状态，数据包还没有到达接收方。

##### 拥塞窗口

~~~
我们把一次性能够发送的数据包多少的窗口称之为拥塞窗口。

在发送数据时，将拥塞窗口的大小与接收端ack的窗口大小做比较，取较小者作为发送数据量的上限。

窗口值的大小代表着能够发送出去的但还没有收到ACK(Acknowledgement确认字符)的最大数据报文段，显然窗口越大那么数据发送的速度也就越快，但是也越可能使得网络出现拥塞
~~~

#### 实现

##### 慢启动

~~~
即由小到大逐渐增大发送窗口，也就是由小到大逐渐增大拥塞窗口数值。cwnd初始值为1，每经过一个传播轮次，cwnd加倍。

当新建连接时，cwnd 初始化为1个最大 报文段(MSS) 大小，发送端开始按照拥塞窗口大小发送数据，每当有一个报文段被确认，cwnd 就增加1个MSS大小。这样 cwnd 的值就随着网络往返时间(Round Trip Time,RTT)呈指数级增长。
开始 ---> cwnd = 1
经过1个RTT后 ---> cwnd = 2*1 = 2
经过2个RTT后 ---> cwnd = 2*2= 4
经过3个RTT后 ---> cwnd = 4*2 = 8

~~~

##### 拥塞避免

~~~
1. 从慢启动可以看到，cwnd可以很快的增长上来，从而最大程度利用网络带宽资源
2. 但是cwnd不能一直这样无限增长下去，一定需要某个限制。

TCP使用了一个叫慢启动门限(ssthresh)的变量，当cwnd超过该值后，慢启动过程结束，进入拥塞避免阶段。当 cwnd>ssthresh时，进入拥塞避免，每一次cwnd不再成倍增加而是 +1

若出现超时，则令 ssthresh = cwnd/2，然后重新执行慢开始算法
~~~

##### 快重传

~~~
发送方只要一连收到三个重复确认，它会假定确认件指出的数据段丢失了，并立即重传这些丢失的数据段。，而不必继续等待设置的重传计时器时间到期。
~~~

##### 快恢复

~~~
1.当收到3个重复ACK时
	ssthresh = cwnd/2，
	cwnd = ssthresh + 3
	然后重传丢失的报文段，加3的原因是因为收到3个重复的ACK，表明有3个“老”的数据包离开了网络。

2. 如果再收到重复 Ack
	cwnd = cwnd +1
	
3.如果收到了新的Ack
	cwnd = sshthresh
~~~



### TCP流量控制

~~~
如果发送者发送数据过快，接收者来不及接收，那么就会有分组丢失。为了避免分组丢失，控制发送者的发送速度，使得接收者来得及接收，这就是流量控制。流量控制根本目的是防止分组丢失，它是构成TCP可靠性的一方面。
~~~

##### 实现

~~~
TCP通过让发送方维护一个称为接收窗口(receive window)的变量(TCP报文段首部的接收窗口字段)来提供流量控制。

接收方每次收到数据包，可以在发送确定报文的时候，同时告诉发送方自己的缓存区还剩余多少是空闲的，我们也把缓存区的剩余大小称之为接收窗口大小，用变量win来表示接收窗口的大小。

因为TCP是全双工通信，在连接两端的发送方都各自维护了一个接收窗口。
~~~

##### 流量控制引发的死锁？怎么避免死锁的发生？

###### 产生

~~~
当发送者收到了一个窗口为0的应答，发送者便停止发送，等待接收者的下一个应答。但是如果这个窗口不为0的应答在传输过程丢失，发送者一直等待下去，而接收者以为发送者已经收到该应答，等待接收新数据，这样双方就相互等待，从而产生死锁。
~~~

###### 避免

~~~
为了避免流量控制引发的死锁，TCP使用了持续计时器。每当发送者收到一个0窗口的应答后就启动该计时器。时间一到便主动发送报文询问接收者的窗口大小。若接收者仍然返回零窗口，则重置该计时器继续等待；若窗口不为0，则表示应答报文丢失了，此时重置发送窗口后开始发送，这样就避免了死锁的产生。
~~~

##### 发送窗口和接受窗口相等吗？

~~~
接收方在发送确认报文的时候，会告诉发送发自己的接收窗口大小，而发送方的发送窗口会据此来设置自己的发送窗口，但这并不意味着他们就会相等。首先接收方把确认报文发出去的那一刻，就已经在一边处理堆在自己缓存区的数据了，所以一般情况下接收窗口 >= 发送窗口。
~~~

##### 拥塞控制和流量控制的区别

>拥塞控制：拥塞控制是作用于网络的，它是防止过多的数据注入到网络中，避免出现网络负载过大的情况；常用的方法就是：（ 1 ）慢开始、拥塞避免（ 2 ）快重传、快恢复。
>
>流量控制：流量控制是作用于接收者的，它是控制发送者的发送速度从而使接收者来得及接收，防止分组丢失的。
>
>